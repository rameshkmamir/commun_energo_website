{% extends 'main/layout.html' %}

{% block title %}Статистика{% endblock %}

{% load static %}

{% block pagename %}
<h1>Статистика</h1>
{% endblock%}

{% block main_content %}
<div class="row">
  <div class="col-md-12">
    <div class="title-panel">
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          var dataString = '{{ data|safe }}'
          var data = JSON.parse(dataString);

          var labels = [];
          var activeData = [];
          var closedData = [];
          var snoozedData = [];

          var uniqueLabels = Array.from(new Set(data.labels));
          uniqueLabels.sort(); // Сортировка дат по возрастанию

          for (var i = 0; i < uniqueLabels.length; i++) {
            var label = uniqueLabels[i];
            var activeCount = data.datasets[0].data.filter(function (date) {
              return date === label;
            }).length;
            var closedCount = data.datasets[1].data.filter(function (date) {
              return date === label;
            }).length;
            var snoozedCount = data.datasets[2].data.filter(function (date) {
              return date === label;
            }).length;

            labels.push(label);
            activeData.push(activeCount);
            closedData.push(closedCount);
            snoozedData.push(snoozedCount);
          }

          var chartData = {
            labels: labels,
            datasets: [
              {
                label: data.datasets[0].label,
                data: activeData,
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1
              },
              {
                label: data.datasets[1].label,
                data: closedData,
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderColor: "rgba(255, 99, 132, 1)",
                borderWidth: 1
              },
              {
                label: data.datasets[2].label,
                data: snoozedData,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1
              }
            ]
          };



          var options = {
            responsive: true,
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Дата',
                  color: '#fff',
                },
                ticks: {
                  color: '#fff',
                }
                
              },
              y: {
                title: {
                  display: true,
                  text: 'Количество заявок',
                  color: '#fff',
                },
                ticks: {
                  stepSize: 1,
                  color: '#fff', // Отображать только целые числа на оси Y
                }
              }
            },
            plugins: {
              title: {
                display: true,
                text: 'График заявок по датам',
                color: '#fff', // Название графика
              },
              legend: {
                labels: {
                  color: '#fff',
                }
                
              }
            }
          };

          var ctx = document.getElementById("chart").getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: chartData,
            options: options
          });
        });
      </script>

    </div>
    <div class="layout-content">
      <button id="filter-btn" class="blue-button">
        Фильтры
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel"
          viewBox="0 0 16 16">
          <path
            d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z" />
        </svg>
      </button>
      <div class="filter-form-conversations" id="q1s1">
        <form method="get" class="filter-form" action="">
          <div class="filters-boxes">
            <div class="filters-up-row" style="margin-top: 15px;">
                <div class="user_box filter-box">
                  <label for="user_name">Назначена на сотрудника</label>
                  <input type="text" class="" id="user_name" name="user_name" placeholder="Введите имя пользователя">
                </div>
                <div class="date-box-1 filter-box">
                  <label for="date_start">Обращение от</label>
                  <input type="date" class="form-control forms-stat-date" id="date" name="date_start">
                </div>
                <div class="date-box-1 filter-box">
                  <label for="date_end">Обращение до</label>
                  <input type="date" class="form-control forms-stat-date" id="date" name="date_end">
                </div>

                <div class="btn-box filter-box">
                  <button type="submit" id='w131' class="submit-btn-filter btn-stat-filter">Фильтровать</button>
                </div>
            </div>

          </div>
        </form>
      </div>
        <div id="data" style="display: none;">{{ data|safe }}</div>
        <div class="container">
          <div class="left-block">
            <canvas id="chart">
            </canvas>
          </div>
          <div class="right-block">
            <div class="top-right-block">Верхний правый блок</div>
            <div class="bottom-right-block">Нижний правый блок</div>
          </div>
        </div>
    </div>
  </div>
</div>

{% endblock %}